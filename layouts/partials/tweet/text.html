{{ $seen_hashtag := newScratch }}
{{ $text := .ctx.text }}
<!-- Entities -->

<!-- Urls -->
{{- range .ctx.entities.urls -}}
  <!-- Link to expanded url -->
  {{- $new := printf 
    "<a target='_blank' rel='noopener noreferrer' href='%s'>%s</a>" 
    (.expanded_url | htmlEscape)
    (.display_url | htmlEscape )
  -}}
  <!-- If url points to quote tweet, remove it -->
  {{ if in .expanded_url .quoted_tweet.id_str }}
    {{ $new = ""}}
  {{ end }}  
  <!-- Replace t.co text with clickable link -->
  {{ $text = replace $text .url $new  }}
{{ end }}

<!-- Hashtags -->
<!-- TODO: Handle hashtags with multiple campaigns  -->
{{ range .ctx.entities.hashtags }}
  {{ if not ($seen_hashtag.Get .text) }}
    <!-- Initialize hashflag variables -->
    {{ $hashflag_markup := "" }}
    
    {{ $date :=  time $.ctx.created_at }}
    {{ $hashtag := (lower .text)}}
    <!-- If hashtag has >1 campaign -->
    {{ with index $.hashtags $hashtag }}
      {{ $campaign := "" }}
      {{/*  Get tweet date    */}}
      {{/*  Choose campaign image within date   */}}
      {{ range $c := . }}
        {{ with index $.campaigns $c }}
          {{ if and (gt .endingTimestampMs $date.UnixMilli) (lt .startingTimestampMs $date.UnixMilli) }}
            {{ $campaign = $c }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ with resources.Get (print "twitter/media/hashflags/" $campaign ".png") }}
        {{ $png := .RelPermalink }}
        {{ $webp := .Resize "72x72 webp q80 drawing" }}
        {{ $filename := (print "twitter/media/hashflags/" $campaign ".webp") }}
        {{ $webp = $webp.Content | resources.FromString $filename }}
        {{ if not $webp.Err }}
          {{ $hashflag_markup = printf "<picture class='emoji'><source srcset='%s' type='image/webp'> <img src='%s'></picture>" $webp.RelPermalink $png }}
        {{ else }}
          {{ warnf "%s" "Hashflags not Optimized"}}
          {{ $hashflag_markup = printf "<picture class='emoji'><img src='%s' alt=''></picture>" .RelPermalink }}
        {{ end }}
        {{ end }}
    {{ end }}

    <!-- Prefix hashtag with # -->
    {{ $old := printf "#%s" .text }}
    <!-- Make hashtag link + optional hashflag -->
    {{ $new := printf "<a target='_blank' rel='noopener noreferrer' href='https://twitter.com/hashtag/%s'>#%s</a> %s" .text .text $hashflag_markup }}
    <!-- Replace text with clickable link -->
    {{ $text = replace $text $old $new }}
    <!-- Mark hashtag as seen -->
    {{ $seen_hashtag.Set .text "true" }}
  {{ end }}
{{ end }}


<!-- Media -->
<!-- Remove all media links -->
{{- range .ctx.entities.media -}}
  {{- $text = replace $text .url "" -}}
{{- end -}}

<!-- Mentions -->
{{- range .ctx.entities.user_mentions -}}
  <!-- Prefix username with @ -->
  {{- $old := printf "@%s" .screen_name -}}
  <!-- Link pointing to user profile. Works even if user changes username -->
  {{- $new := printf "<a href='https://twitter.com/intent/user?user_id=%s'>@%s</a>" .id_str .screen_name -}}
  <!-- Replace text with clickable link -->
  {{- $text = replace $text $old $new -}}
{{- end -}}


<!-- 4. Symbols/Cashflags -->
{{ range .ctx.entities.symbols }}
  {{ $old := printf "$%s" .text }}
  {{ $new := printf "<a target='_blank' rel='noopener noreferrer' href='https://twitter.com/search?q=%24%s'>$%s</a>" .text .text }}
  {{ $text = replace $text $old $new }}
{{ end }}

<p class="text">
    {{- $text | safeHTML -}}
</p>
