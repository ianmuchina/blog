{{ $res := ""}}
{{- $id := .Get "id" -}}
{{/*  <!-- Load Tweet Data -->  */}}
{{- $res = getJSON "https://cdn.syndication.twimg.com/tweet?id=" $id -}}
{{/* WARNING: Very unsafe, will cause xss if malicious input is entered  */}}

{{/* Process FullText by replacing entitity text with anchor links. */}}
{{ $text := $res.text}}
{{/* User Mentions */}}
{{ range $user := $res.entities.user_mentions}}
  {{ $u := $user.screen_name }}
  {{ $1 := printf "@%s" $u }}
  {{ $2 := printf "<a href='https://twitter.com/%s'>@%s</a>" $u $u }}
  {{ $text = replace $text $1 $2 }}
{{ end }}

{{/* Media */}}
{{ range $media := $res.entities.media }}
  {{ $text = replace $text $media.url "" }}
{{ end }}

{{/* Urls */}}
{{ range $res.entities.urls}}
  {{ $text = replace $text .url (printf "<a href='%s'>%s</a>" .expanded_url .display_url) }}
{{ end }}

{{/* Hashtags */}}
{{ range $res.entities.hashtags }}
  {{ $1 := printf "#%s" .text }}
  {{ $2 := printf "<a target='_blank' rel='noopener noreferrer' href='https://twitter.com/hashtag/%s'>#%s</a>" .text .text }}
  {{ $text = replace $text $1 $2  }}
{{ end }}
{{/* Entity: Symbol */}}
{{ range $res.entities.symbols }}
  {{ $1 := printf "$%s" .text }}
  {{ $2 := printf "<a target='_blank' rel='noopener noreferrer' href='https://twitter.com/search?q=%24%s'>$%s</a>" .text .text }}
  {{ $text = replace $text $1 $2 }}
{{ end }}
{{/* Compact notation for likes
       eg: 1734 to 1.7K */}}
{{ $likes := $res.favorite_count }}
{{ $k := math.Floor	(div $likes 1000) }}
{{ $h := math.Floor	(mul .01 (mod $likes 1000)) }}

{{if (gt $k 0) }}
  {{$likes = print $k "K" }}
{{end}}
 
{{if and (gt $k 0) (gt $h 0) }}
  {{$likes = print $k "." $h "K" }}
{{ end }}

{{/*  Polls  */}}

{{$totalCount := 0}}
{{$maxCount := 0}}

{{$pollVal1 := 0}}
{{$pollVal2 := 0}}
{{$pollVal3 := 0}}
{{$pollVal4 := 0}}  

{{$pollStr1 := ""}}
{{$pollStr2 := ""}}
{{$pollStr3 := ""}}
{{$pollStr4 := ""}}  


{{ $polls := slice }}

{{- if $res.card.binding_values.choice1_count.string_value -}}

  {{/*  1 & 2  */}}
  {{ $pollVal1 = int $res.card.binding_values.choice1_count.string_value }}
  {{ $pollVal2 = int $res.card.binding_values.choice2_count.string_value }}

  {{ $pollStr1 = $res.card.binding_values.choice1_label.string_value }}
  {{ $pollStr2 = $res.card.binding_values.choice2_label.string_value }}

  {{ $polls = $polls | append (dict "count" $pollVal1 "label" $pollStr1) }}
  {{ $polls = $polls | append (dict "count" $pollVal2 "label" $pollStr2) }}

  {{/*  3 (Optional)  */}}
  {{ if $res.card.binding_values.choice3_count.string_value }}
    {{ $pollVal3 = int $res.card.binding_values.choice3_count.string_value}}
    {{ $pollStr3 = $res.card.binding_values.choice3_label.string_value }}
    {{ $polls = $polls | append (dict "count" $pollVal3 "label" $pollStr3) }}

  {{ end }}

  {{/*  4 Optional  */}}
  {{ if $res.card.binding_values.choice4_count.string_value }}

  {{ $pollVal4 = int $res.card.binding_values.choice4_count.string_value}}
  {{ $pollStr4 = $res.card.binding_values.choice4_label.string_value }}
    
    {{ $polls = $polls | append (dict "count" $pollVal4 "label" $pollStr4) }}
    
  {{ end }}
{{- end -}}

{{ $totalCount = (add (add $pollVal1 $pollVal2) (add $pollVal3 $pollVal4 )) }}
{{ $maxCount = int (math.Max 
  (math.Max $pollVal1 $pollVal2)
  (math.Max $pollVal3 $pollVal4 )) }}
  
  {{/*  Variables  */}}
  {{- $host := "https://twitter.com/" -}}
  {{- $tweetUrl := print $host (printf "%s/status/%s" $res.user.screen_name $res.id_str) -}}
  {{- $replyUrl := print $host (printf "intent/like?in_reply_to=%s" $res.id_str) -}}
  {{- $likeUrl  := print $host (printf "intent/like?tweet_id=%s" $res.id_str) -}}
  {{- $userUrl  := print $host (printf "i/user/%s" $res.user.id_str) -}}
  {{/* _normal:"48x48", _bigger:"73x73", _mini:"24x24" " " (blank):"original" */}}
  {{$profilePic := replace $res.user.profile_image_url_https "_normal" "_bigger"}}
  {{- with $res -}}
  <article
  class="tweet" lang="{{.lang}}"> 
  <!-- User Info -->
  <div class="userInfo">
    <img loading="lazy" src={{ $profilePic}} class="profilePhoto"/> <div>
      <!-- UserName -->
      <a target="_blank" rel="noopener noreferrer" class="userName" href={{$userUrl}}>
        <span class="tw-name">{{- .user.name -}}</span>
          <!-- Checkmark -->
          {{- if .user.verified -}}
            {{ resources.Get "tw-checkmark.svg" | safeHTML }}
          <!-- TODO -->
          {{- end -}}
        </a>
        <!-- Screen Name -->
        <span class="screenName">@<span>{{.user.screen_name}}</span>
      </span>
    </div>
  </div>
  <!-- FullText -->
  <p class="fullText">
    {{- $text | safeHTML -}}
  </p>
  <!-- Polls -->
  {{ if (gt (len $polls) 0) }}
  <section class="polls">
    {{ range $polls }}
     {{ $percent := (math.Round ( mul ( div ( add .count 0.0 ) $totalCount) 100)) }}  
      <div class="poll_container {{if eq .count $maxCount}}win{{end}}">
        <div class="progress_container_text">
          <span>
            {{ .label }} &nbsp; {{ .count }} </span>
          <span> {{ $percent }}%</span>
        </div>

        <div 
          style="width: {{$percent}}%;"
          class="progress_bar {{if eq .count $maxCount}}win_bar{{end}}"
          aria-hidden="true">
        </div>
      </div>
    {{ end }}
    <div class="text-secondary">
      {{$totalCount}} votes
    </div>
  </section>
  
  {{ end }}
  
  <!-- End Polls -->
  
  <!-- OpenGraph -->
  {{ if .card.binding_values.domain }}
    
  {{ with .card.binding_values }}
  {{/* Wide */}}
  <section class="card {{ if .summary_photo_image_large }}card_large {{else}}card_small{{end}}">
    {{ $url := .card_url.string_value }}
    
    {{/* replace twitter url with expanded url  */}}
    {{ range $res.entities.urls}}
    {{ if (eq $url .url) }}
    {{ $url = .expanded_url}}
    {{ end }}  
    {{ end }}
    
    <a href="{{$url}}" class="overlay"></a>
    <img class="card_thumbnail" src="{{.thumbnail_image_large.image_value.url}}" alt="">
        <div class="card_content">
          <div class="vanity_url">{{.vanity_url.string_value}}</div>
          <div class="title">{{.title.string_value}}</div>
          <p class="description"> {{.description.string_value | truncate 110 }}</p>
        </div>
      </section>
      {{ end }}
      {{ end }}
      <!-- End OpenGraph -->
      <!-- Gallery -->
      {{ if .photos }}
      {{ $photosCount := len .photos }}
      <div class="gallery gallery-{{$photosCount}}">
        {{ range .photos }}
          <img loading="lazy" src="{{.url}}:small" {{ if .accessibilityLabel }} alt={{ .accessibilityLabel }} {{end}}/>
        {{ end }}
      </div>
    {{ end }}
    <!-- End Gallery -->
    <!-- Videos & Gifs -->
    {{ if .video }}
      <section>
        <!-- Gif -->
        {{if eq .video.contentType "gif"}}
          <video loop muted autoplay poster={{.video.poster}}>
            {{ range .video.variants }}
              <source src={{.src}} type={{.type}}/>
            {{ end }}
          </video>
        {{ end }}
        <!-- Video -->
        {{ if eq .video.contentType "media_entity" }}
          <video preload="metadata" controls loop poster={{.video.poster}}>
            {{ range .video.variants }}
              <source  src={{.src}} type={{.type}}/>
            {{ end }}
          </video>
        {{ end }}
      </section>
    {{ end }}
    <!-- End Videos & Gifs -->

    {{/*  Quoted Tweet  */}}
    {{/*  TODO: Make this DRY */}}
    {{ if .quoted_tweet }}
    {{ with .quoted_tweet }}
    {{/* Process FullText by replacing entitity text with anchor links. */}}
      {{ $text := .text}}
      {{- $tweetUrl := print $host (printf "%s/status/%s" .user.screen_name $res.id_str) -}}
      {{- $userUrl  := print $host (printf "i/user/%s" .user.id_str) -}}

      {{/* User Mentions */}}
      {{ range $user := .entities.user_mentions}}
        {{ $u := $user.screen_name }}
        {{ $1 := printf "@%s" $u }}
        {{ $2 := printf "<a href='https://twitter.com/%s'>@%s</a>" $u $u }}
        {{ $text = replace $text $1 $2 }}
      {{ end }}

      {{/* Media */}}
      {{ range $media := .entities.media }}
        {{ $text = replace $text $media.url "" }}
      {{ end }}

      {{/* Urls */}}
      {{ range .entities.urls}}
        {{ $text = replace $text .url (printf "<a href='%s'>%s</a>" .expanded_url .display_url) }}
      {{ end }}

      {{/* Hashtags */}}
      {{ range .entities.hashtags }}
        {{ $1 := printf "#%s" .text }}
        {{ $2 := printf "<a target='_blank' rel='noopener noreferrer' href='https://twitter.com/hashtag/%s'>#%s</a>" .text .text }}
        {{ $text = replace $text $1 $2  }}
      {{ end }}
      {{/* Entity: Symbol */}}
      {{ range .entities.symbols }}
        {{ $1 := printf "$%s" .text }}
        {{ $2 := printf "<a target='_blank' rel='noopener noreferrer' href='https://twitter.com/search?q=%24%s'>$%s</a>" .text .text }}
        {{ $text = replace $text $1 $2 }}
      {{ end }}

      <article lang="{{.lang}}" class="quote_tweet" >
        <div class="userInfo">
          {{$profilePic := replace .user.profile_image_url_https "_normal" "_mini"}}
          <img loading="lazy" src={{$profilePic}} class="profilePhoto"/> 
          <div>
            <!-- UserName -->
            <a target="_blank" rel="noopener noreferrer" class="userName" href={{$userUrl}}>
              <span class="tw-name">{{- .user.name -}}</span>
                <!-- Checkmark -->
                {{- if .user.verified -}}
                  {{ resources.Get "tw-checkmark.svg" | safeHTML }}
                <!-- TODO -->
                {{- end -}}
              </a>
              <!-- Screen Name -->
              <span class="screenName">@<span>{{.user.screen_name}}</span>
            </span>
          </div>
        </div>

        <p class="fullText"> {{- $text | safeHTML -}} </p>

        <!-- Videos & Gifs -->
            <!-- Gif -->
            {{if eq .video.contentType "gif"}}
              <video loop muted autoplay poster={{.video.poster}}>
                {{ range .video.variants }}
                  <source src={{.src}} type={{.type}}/>
                {{ end }}
              </video>
            {{ end }}
              <!-- Video -->
    
              {{ if eq .video.contentType "media_entity" }}
                <video loop poster='{{.video.poster}}'  controls>
                  {{ range .video.variants }}
                  <source  src='{{.src}}' type="{{.type}}" />
                  {{ end }}
                </video>
              {{ end }}
        <!-- End Videos & Gifs -->

      </article>
    {{ end }}
    {{ end }}
    <!-- Date -->
    {{$date := "10:13 AM · Jul 04, 2021"}}
    <a class="tw-date" aria-label="Posted on {{$date}}" href={{ $tweetUrl }}>{{ time.Format "3:04 PM · Jan 2, 2006 UTC" .created_at  }}</a>
    
    <!-- Metadata: Likes, Link to tweet -->
    <section
      class="meta">
      <!-- Likes -->
      <a class="likes" href="{{ $likeUrl }}" target="_blank" rel="noopener noreferrer" >
        
        {{ partial "inline-svg" "twitter/like"}}          
        {{$likes}}
      </a>
      <!-- Link To Tweet -->
      <a href={{ $tweetUrl }} target="_blank" rel="noopener noreferrer" class="link">
        {{ partial "inline-svg" "twitter/link"}}
        Link to Tweet
      </a>
    </section>
  </article>
{{- end -}}